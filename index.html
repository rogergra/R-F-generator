<!--
    ElecFacture Pro - Version améliorée
    - Validation avancée des champs
    - Statut de paiement interactif
    - Recherche/filtres dans l'historique
    - Design modernisé et responsive
    - Code JS structuré et commenté
-->
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ElecFacture Pro | Gestion Complète</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    
    <link rel="stylesheet" href="styles.css">
    <!--<link rel="stylesheet" href="styles2.css">-->
    <style>
        body { background: #f7fafd; font-family: 'Segoe UI', Arial, sans-serif; }
        .app-header { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 20px 30px; box-shadow: 0 2px 8px #e0e7ef; }
        .logo-container { display: flex; align-items: center; }
        .logo { background: #1e90ff; color: #fff; border-radius: 50%; width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; font-size: 2rem; margin-right: 15px; }
        .app-title { font-size: 2rem; font-weight: 700; color: #222; }
        .app-title span { color: #1e90ff; }
        .app-controls .btn { margin-left: 10px; }
        .app-container { display: flex; flex-wrap: wrap; }
        .sidebar { background: #fff; padding: 30px 20px; width: 340px; min-width: 300px; box-shadow: 2px 0 8px #e0e7ef; }
        .main-content { flex: 1; padding: 30px 40px; }
        .section-title { font-size: 1.2rem; color: #1e90ff; margin-bottom: 15px; }
        .form-group, .form-row { margin-bottom: 18px; }
        .form-label { font-weight: 500; color: #444; }
        .form-input { width: 100%; padding: 8px 12px; border: 1px solid #dbeafe; border-radius: 5px; font-size: 1rem; }
        .btn { border: none; border-radius: 5px; padding: 10px 18px; font-size: 1rem; cursor: pointer; transition: background 0.2s; }
        .btn-primary { background: #1e90ff; color: #fff; }
        .btn-secondary { background: #e0e7ef; color: #1e90ff; }
        .btn-danger { background: #ff4d4f; color: #fff; }
        .btn:active { opacity: 0.8; }
        .preview-section, .history-section { margin-bottom: 40px; }
        .invoice-container { background: #fff; border-radius: 10px; box-shadow: 0 2px 12px #e0e7ef; padding: 30px; margin-bottom: 20px; }
        .invoice-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #e0e7ef; padding-bottom: 18px; margin-bottom: 18px; }
        .invoice-logo { font-size: 2.5rem; color: #1e90ff; }
        .client-section, .consumption-section, .pricing-section, .payment-section, .signature
        .client-section, .consumption-section, .pricing-section, .payment-section, .signature-section { margin-bottom: 30px; }
        .invoice-section-title { font-weight: 600; color: #1e90ff; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; }
        .info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .info-item { background: #f1f5fa; border-radius: 5px; padding: 8px 12px; }
        .info-label { font-size: 0.95rem; color: #888; }
        .info-value { font-weight: 600; color: #222; }
        .meter-grid { display: flex; gap: 18px; margin-bottom: 10px; }
        .meter-card { flex: 1; background: #f1f5fa; border-radius: 7px; padding: 12px; text-align: center; }
        .meter-value { font-size: 1.3rem; font-weight: 700; color: #1e90ff; }
        .meter-unit { font-size: 0.95rem; color: #888; }
        .pricing-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .pricing-table th, .pricing-table td { border: 1px solid #e0e7ef; padding: 8px 10px; text-align: left; }
        .pricing-table th { background: #f1f5fa; }
        .total-row td { font-weight: 700; color: #1e90ff; }
        .payment-methods { display: flex; gap: 12px; margin-top: 10px; }
        .method-card { background: #f1f5fa; border-radius: 5px; padding: 8px 14px; display: flex; align-items: center; gap: 7px; font-size: 1rem; }
        .status-info { margin-top: 18px; }
        .status-card { background: #f1f5fa; border-radius: 7px; padding: 12px; }
        .status-options { display: flex; gap: 18px; margin: 10px 0; }
        .status-option { cursor: pointer; padding: 8px 12px; border-radius: 5px; background: #e0e7ef; color: #1e90ff; display: flex; align-items: center; gap: 6px; transition: background 0.2s; }
        .status-option.active, .status-option:hover { background: #1e90ff; color: #fff; }
        .penalty-info { font-size: 0.95rem; color: #ff9800; margin-top: 8px; }
        .signature-section { display: flex; gap: 40px; }
        .signature-box { flex: 1; text-align: center; }
        .signature-placeholder { height: 40px; border-bottom: 1px dashed #bbb; margin: 10px 0; }
        .action-buttons { display: flex; gap: 15px; justify-content: center; margin-top: 20px; }
        .loader { display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(255,255,255,0.7); z-index: 9999; align-items: center; justify-content: center; }
        .spinner { border: 6px solid #e0e7ef; border-top: 6px solid #1e90ff; border-radius: 50%; width: 48px; height: 48px; animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 30px; right: 30px; background: #1e90ff; color: #fff; padding: 14px 22px; border-radius: 7px; box-shadow: 0 2px 8px #e0e7ef; opacity: 0; pointer-events: none; transition: opacity 0.3s; z-index: 10000; display: flex; align-items: center; gap: 10px; }
        .toast.show { opacity: 1; pointer-events: auto; }
        .invoices-list { margin-top: 10px; }
        .invoice-card { background: #fff; border-radius: 8px; box-shadow: 0 1px 6px #e0e7ef; padding: 16px 18px; margin-bottom: 14px; display: flex; align-items: center; justify-content: space-between; gap: 10px; }
        .invoice-info-card { flex: 2; }
        .invoice-title { font-weight: 600; color: #1e90ff; }
        .invoice-meta { font-size: 0.95rem; color: #888; margin-top: 3px; }
        .invoice-amount { font-weight: 700; color: #222; flex: 1; text-align: right; }
        .invoice-status { padding: 6px 12px; border-radius: 5px; font-weight: 600; }
        .invoice-status.paid { background: #e6ffed; color: #27ae60; }
        .invoice-status.pending { background: #fffbe6; color: #f39c12; }
        .invoice-status.overdue { background: #ffeaea; color: #e74c3c; }
        .invoice-actions button { margin-left: 6px; }
        .search-bar { margin-bottom: 18px; }
        @media (max-width: 900px) {
            .app-container { flex-direction: column; }
            .sidebar { width: 100%; min-width: unset; box-shadow: none; }
            .main-content { padding: 20px 5vw; }
        }
    </style>
</head>
<body>

    <!-- ...existing code... -->
    <div id="loginScreen"
        style="display:none;position:fixed;z-index:99999;top:0;left:0;width:100vw;height:100vh;background:linear-gradient(135deg,#1e90ff 0%,#f7fafd 100%);align-items:center;justify-content:center;">
        <form id="loginForm"
            style="background:#fff;padding:38px 32px 28px 32px;border-radius:16px;box-shadow:0 6px 32px #1e90ff33, 0 1.5px 8px #e0e7ef;max-width:350px;margin:auto;display:flex;flex-direction:column;gap:18px;">
            <div style="display:flex;flex-direction:column;align-items:center;gap:8px;">
                <div
                    style="background:#1e90ff;border-radius:50%;width:60px;height:60px;display:flex;align-items:center;justify-content:center;">
                    <i class="fas fa-user-lock" style="color:#fff;font-size:2rem;"></i>
                </div>
                <h2 style="text-align:center;color:#1e90ff;margin:0;font-size:1.5rem;">Connexion sécurisée</h2>
                <div style="color:#7b8793;font-size:0.98em;text-align:center;">Veuillez vous authentifier pour accéder à
                    votre espace facturation.</div>
            </div>
            <div>
                <label for="loginUser" style="font-weight:500;color:#1e90ff;margin-bottom:4px;display:block;">Nom
                    d'utilisateur</label>
                <input type="text" id="loginUser" class="form-input" placeholder="Nom d'utilisateur" required
                    style="width:100%;border:1.5px solid #dbeafe;border-radius:6px;padding:10px 12px;font-size:1.08em;">
            </div>
            <div>
                <label for="loginPass" style="font-weight:500;color:#1e90ff;margin-bottom:4px;display:block;">Mot de
                    passe</label>
                <input type="password" id="loginPass" class="form-input" placeholder="Mot de passe" required
                    style="width:100%;border:1.5px solid #dbeafe;border-radius:6px;padding:10px 12px;font-size:1.08em;">
            </div>
            <button type="submit" class="btn btn-primary"
                style="width:100%;font-size:1.1em;padding:12px 0;margin-top:8px;letter-spacing:1px;box-shadow:0 2px 8px #1e90ff22;">Se
                connecter</button>
            <div id="loginError"
                style="color:#e74c3c;text-align:center;margin-top:8px;display:none;font-size:1.05em;font-weight:500;"></div>
            <div style="text-align:center;margin-top:10px;font-size:0.97em;color:#888;">
                <i class="fas fa-info-circle"></i> Utilisateur : <b>Rogastech</b><br>
                Mot de passe : <b>1234</b>
            </div>
        </form>
    </div>
    <!-- ...existing code... -->



    <div class="app-header">
        <div class="logo-container">
            <div class="logo"><i class="fas fa-bolt"></i></div>
            <h1 class="app-title">Rtech<span> Facture</span> Elec</h1>
        </div>
        <div class="app-controls">
            <button id="newBtn" class="btn btn-secondary"><i class="fas fa-file"></i> Nouveau</button>
            <button id="saveBtn" class="btn btn-secondary"><i class="fas fa-save"></i> Enregistrer</button>
            <button id="exportBtn" class="btn btn-primary"><i class="fas fa-download"></i> Exporter PDF</button>
            <input type="file" id="importJson" accept=".json" style="display:none;">
            <button id="importBtn" class="btn btn-secondary"><i class="fas fa-upload"></i> Importer historique</button>
            <button id="exportHistoryBtn" class="btn btn-secondary"><i class="fas fa-download"></i> Exporter historique</button>

        </div>

        <div id="changePwdModal"
            style="display:none;position:fixed;z-index:100000;top:0;left:0;width:100vw;height:100vh;background:rgba(30,144,255,0.12);align-items:center;justify-content:center;">
            <form id="changePwdForm"
                style="background:#fff;padding:28px 24px;border-radius:12px;box-shadow:0 2px 16px #1e90ff33;max-width:340px;margin:auto;display:flex;flex-direction:column;gap:16px;">
                <h3 style="color:#1e90ff;text-align:center;margin-bottom:8px;">Changer le mot de passe</h3>
                <input type="password" id="oldPwd" class="form-input" placeholder="Ancien mot de passe" required>
                <input type="password" id="newPwd" class="form-input" placeholder="Nouveau mot de passe" required>
                <input type="password" id="confirmPwd" class="form-input" placeholder="Confirmer le nouveau mot de passe"
                    required>
                <button type="submit" class="btn btn-primary" style="width:100%;">Valider</button>
                <div id="changePwdError" style="color:#e74c3c;text-align:center;display:none;"></div>
                <button type="button" class="btn btn-secondary" style="width:100%;"
                    onclick="closeChangePwdModal()">Annuler</button>
            </form>
        </div>
    </div>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <h2 class="section-title"><i class="fas fa-user"></i> Informations Client</h2>
            <div class="form-group">
                <label class="form-label">Nom Complet *</label>
                <input type="text" id="clientName" class="form-input" placeholder="Roger Rogas" required>
            </div>
            <div class="form-group">
                <label class="form-label">Adresse *</label>
                <input type="text" id="clientAddress" class="form-input" placeholder="Anfame, atigagome" required>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">N° Facture *</label>
                    <input type="text" id="clientId" class="form-input" placeholder="0000" required>
                </div>
                <div class="form-group">
                    <label class="form-label">N° Compteur *</label>
                    <input type="text" id="meterId" class="form-input" placeholder="CMP-7B82-4691" required>
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">Téléphone</label>
                <input type="text" id="clientPhone" class="form-input" placeholder="90 00 00 00">
            </div>
            <h2 class="section-title"><i class="fas fa-calculator"></i> Détails Facturation</h2>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Date d'Émission *</label>
                    <input type="date" id="issueDate" class="form-input" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Période *</label>
                    <input type="text" id="period" class="form-input" placeholder="Ex: 01 Juil - 31 Juil 2023" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Ancien Index (kWh) *</label>
                    <input type="number" id="oldIndex" class="form-input" placeholder="0000" min="0" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Nouvel Index (kWh) *</label>
                    <input type="number" id="newIndex" class="form-input" placeholder="0000" min="0" required>
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Tarif par kWh (F CFA) *</label>
                    <input type="number" id="ratePerKwh" class="form-input" placeholder="85" min="1" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Frais d'entretien (F CFA)</label>
                    <input type="number" id="fixedFees" class="form-input" placeholder="500" min="0">
                </div>
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label class="form-label">Taux TVA (%)</label>
                    <input type="number" id="taxRate" class="form-input" placeholder="18" min="0">
                </div>
                <div class="form-group">
                    <label class="form-label">Autres Frais (F CFA)</label>
                    <input type="number" id="otherFees" class="form-input" placeholder="0" min="0">
                </div>
            </div>
            <button id="generateBtn" class="btn btn-primary" style="width:100%;margin-top:10px;">
                <i class="fas fa-sync-alt"></i> Générer Facture
            </button>
        </div>
        <!-- Main Content -->
        <div class="main-content">
            <div class="preview-section">
                <h2 class="section-title"><i class="fas fa-eye"></i> Aperçu de la Facture</h2>
                <div id="invoicePreview" class="invoice-container"></div>
            </div>
            <div class="history-section">
                <h2 class="section-title"><i class="fas fa-history"></i> Historique des Factures</h2>
                <div class="search-bar">
                    <input type="text" id="searchInvoice" class="form-input" placeholder="Rechercher par nom, n° facture...">
                </div>
                <div class="invoices-list" id="invoicesList"></div>
            </div>
        </div>
    </div>
    <div class="loader" id="loader"><div class="spinner"></div></div>
    <div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage"></span></div>
    <script>
        // --- Backend simulation ---
        class ElecFactureBackend {
            constructor() {
                this.invoices = JSON.parse(localStorage.getItem('invoices')) || [];
            }
            saveInvoice(invoiceData) {
                // Empêche les doublons (même n° facture)
                const exist = this.invoices.find(inv => inv.clientId === invoiceData.clientId);
                if (exist) Object.assign(exist, invoiceData, { updatedAt: new Date().toISOString() });
                else this.invoices.unshift({ ...invoiceData, id: 'INV-' + Date.now(), createdAt: new Date().toISOString(), status: invoiceData.status || 'pending' });
                this.persistData();
            }
            updateInvoiceStatus(invoiceId, status) {
                const inv = this.invoices.find(i => i.id === invoiceId);
                if (inv) { inv.status = status; this.persistData(); }
            }
            deleteInvoice(invoiceId) {
                this.invoices = this.invoices.filter(i => i.id !== invoiceId);
                this.persistData();
            }
            getAllInvoices() { return [...this.invoices].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt)); }
            getInvoiceById(invoiceId) { return this.invoices.find(i => i.id === invoiceId); }
            persistData() { localStorage.setItem('invoices', JSON.stringify(this.invoices)); }
        }
        const backend = new ElecFactureBackend();

        // --- DOM Elements ---
        const clientName = document.getElementById('clientName');
        const clientAddress = document.getElementById('clientAddress');
        const clientId = document.getElementById('clientId');
        const meterId = document.getElementById('meterId');
        const clientPhone = document.getElementById('clientPhone');
        const issueDate = document.getElementById('issueDate');
        const period = document.getElementById('period');
        const oldIndex = document.getElementById('oldIndex');
        const newIndex = document.getElementById('newIndex');
        const ratePerKwh = document.getElementById('ratePerKwh');
        const fixedFees = document.getElementById('fixedFees');
        const taxRate = document.getElementById('taxRate');
        const otherFees = document.getElementById('otherFees');
        const generateBtn = document.getElementById('generateBtn');
        const exportBtn = document.getElementById('exportBtn');
        const newBtn = document.getElementById('newBtn');
        const saveBtn = document.getElementById('saveBtn');
        const invoicePreview = document.getElementById('invoicePreview');
        const invoicesList = document.getElementById('invoicesList');
        const loader = document.getElementById('loader');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const searchInvoice = document.getElementById('searchInvoice');
        const { jsPDF } = window.jspdf;

        // --- Utils ---
        function showToast(msg) {
            toastMessage.textContent = msg;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        function formatDate(dateString) {
            if (!dateString) return '';
            const options = { day: '2-digit', month: 'long', year: 'numeric' };
            return new Date(dateString).toLocaleDateString('fr-FR', options);
        }
        function formatNumber(num) {
            return (num || 0).toLocaleString('fr-FR');
        }
        function numberToFrenchWords(num) {
            // ... (identique à ton code, pour la concision)
            const units = ['', 'un', 'deux', 'trois', 'quatre', 'cinq', 'six', 'sept', 'huit', 'neuf'];
            const teens = ['dix', 'onze', 'douze', 'treize', 'quatorze', 'quinze', 'seize', 'dix-sept', 'dix-huit', 'dix-neuf'];
            const tens = ['', '', 'vingt', 'trente', 'quarante', 'cinquante', 'soixante', 'soixante', 'quatre-vingt', 'quatre-vingt'];
            if (num === 0) return 'zéro';
            let words = '';
            if (num >= 1000) { const thousands = Math.floor(num / 1000); words += (thousands === 1 ? 'mille ' : numberToFrenchWords(thousands) + ' mille '); num %= 1000; }
            if (num >= 100) { const hundreds = Math.floor(num / 100); words += (hundreds === 1 ? 'cent ' : units[hundreds] + ' cent '); num %= 100; }
            if (num > 0) {
                if (words !== '') words += ' ';
                if (num < 10) words += units[num];
                else if (num < 20) words += teens[num - 10];
                else {
                    const ten = Math.floor(num / 10), unit = num % 10;
                    if (ten === 7 || ten === 9) words += tens[ten] + '-' + (ten === 7 ? teens[unit] : (unit === 1 ? 'onze' : teens[unit]));
                    else { words += tens[ten]; if (unit > 0) { words += (ten === 8 && unit === 0) ? 's' : ''; words += (ten > 1 && unit === 1) ? ' et ' : '-'; words += units[unit]; } else if (ten === 8) words += 's'; }
                }
            }
            return words.trim();
        }

        // --- Validation avancée ---
        function validateFields() {
            if (!clientName.value.trim()) { showToast("Nom du client obligatoire."); clientName.focus(); return false; }
            if (!clientAddress.value.trim()) { showToast("Adresse obligatoire."); clientAddress.focus(); return false; }
            if (!clientId.value.trim()) { showToast("N° Facture obligatoire."); clientId.focus(); return false; }
            if (!meterId.value.trim()) { showToast("N° Compteur obligatoire."); meterId.focus(); return false; }
            if (!issueDate.value) { showToast("Date d'émission obligatoire."); issueDate.focus(); return false; }
            if (!period.value.trim()) { showToast("Période obligatoire."); period.focus(); return false; }
            if (!oldIndex.value || !newIndex.value) { showToast("Saisir les index."); oldIndex.focus(); return false; }
            if (parseFloat(newIndex.value) < parseFloat(oldIndex.value)) { showToast("Nouvel index doit être supérieur à l'ancien."); newIndex.focus(); return false; }
            if (!ratePerKwh.value || parseFloat(ratePerKwh.value) <= 0) { showToast("Tarif kWh invalide."); ratePerKwh.focus(); return false; }
            return true;
        }

        // --- Calculs ---
        function calculateInvoice() {
            const oldIdx = parseFloat(oldIndex.value) || 0, newIdx = parseFloat(newIndex.value) || 0;
            const rate = parseFloat(ratePerKwh.value) || 0, fixed = parseFloat(fixedFees.value) || 0;
            const tax = parseFloat(taxRate.value) || 0, other = parseFloat(otherFees.value) || 0;
            const consumption = newIdx - oldIdx;
            const consumptionCost = consumption * rate;
            const subtotal = consumptionCost + fixed + other;
            const taxAmount = (subtotal * tax) / 100;
            const total = subtotal + taxAmount;
            return { consumption, consumptionCost, subtotal, taxAmount, total };
        }

        // --- Génération de la facture ---
        let currentStatus = 'pending';
        function generateInvoice(status = currentStatus) {
            if (!validateFields()) return;
            loader.style.display = 'flex';
            setTimeout(() => {
                const data = calculateInvoice();
                const dueDate = new Date(issueDate.value); dueDate.setDate(dueDate.getDate() + 10); // 10 jours après l'émission
                invoicePreview.innerHTML = `
                    <div class="invoice-header">
                        <div class="header-left">
                            <h1>FACTURE D'ÉLECTRICITÉ</h1>
                            <p>Relevé de consommation </p>
                        </div>
                        <div class="invoice-logo"><i class="fas fa-bolt"></i></div>
                    </div>
                    <div class="client-section">
                        <div class="client-info">
                            <div class="invoice-section-title"><i class="fas fa-user"></i> INFORMATIONS CLIENT</div>
                            <div class="info-grid">
                                <div class="info-item"><div class="info-label">Nom complet</div><div class="info-value">${clientName.value}</div></div>
                                <div class="info-item"><div class="info-label">Adresse</div><div class="info-value">${clientAddress.value}</div></div>
                                <div class="info-item"><div class="info-label">N° Facture</div><div class="info-value">${clientId.value}</div></div>
                                <div class="info-item"><div class="info-label">N° Compteur</div><div class="info-value">${meterId.value}</div></div>
                            </div>
                        </div>
                        <div class="invoice-info">
                            <div class="invoice-section-title"><i class="fas fa-file-invoice"></i> DÉTAILS FACTURE</div>
                            <div class="info-grid">
                                <div class="info-item"><div class="info-label">Date d'émission</div><div class="info-value">${formatDate(issueDate.value)}</div></div>
                                <div class="info-item"><div class="info-label">Période concernée</div><div class="info-value">${period.value}</div></div>
                                <div class="info-item"><div class="info-label">Date limite</div><div class="info-value">${formatDate(dueDate)}</div></div>
                            </div>
                        </div>
                    </div>
                    <div class="consumption-section">
                        <div class="invoice-section-title"><i class="fas fa-tachometer-alt"></i> RELEVÉ DE CONSOMMATION</div>
                        <div class="meter-grid">
                            <div class="meter-card"><h3>ANCIEN INDEX</h3><div class="meter-value">${formatNumber(oldIndex.value)}</div><div class="meter-unit">kWh</div></div>
                            <div class="meter-card"><h3>NOUVEL INDEX</h3><div class="meter-value">${formatNumber(newIndex.value)}</div><div class="meter-unit">kWh</div></div>
                            <div class="meter-card"><h3>CONSOMMATION</h3><div class="meter-value">${formatNumber(data.consumption)}</div><div class="meter-unit">kWh</div></div>
                        </div>
                        <div class="consumption-details">
                            <div class="consumption-text">Tarif appliqué: <strong>${ratePerKwh.value} FCFA/kWh</strong></div>
                            <div class="consumption-value">Coût: ${formatNumber(data.consumptionCost)} FCFA</div>
                        </div>
                    </div>
                    <div class="pricing-section">
                        <div class="invoice-section-title"><i class="fas fa-calculator"></i> DÉTAILS DE TARIFICATION</div>
                        <table class="pricing-table">
                            <thead>
                                <tr><th   style="font-weight: bold; color: #3498db;">DÉSIGNATION</th><th  style="font-weight: bold; color: #3498db;">DÉTAILS</th><th style="font-weight: bold; color: #3498db;">MONTANT (F CFA)</th></tr>
                            </thead>
                            <tbody>
                                <tr><td>Consommation électrique</td><td>${formatNumber(data.consumption)} kWh × ${ratePerKwh.value} FCFA</td><td>${formatNumber(data.consumptionCost)}</td></tr>
                                <tr><td>Frais d'entretien</td><td>Frais fixes</td><td>${formatNumber(fixedFees.value || 0)}</td></tr>
                                <tr><td>Taxes (TVA ${taxRate.value || 0}%)</td><td>Sur consommation</td><td>${formatNumber(data.taxAmount)}</td></tr>
                                <tr><td>Contribution service</td><td>Frais obligatoire</td><td>${formatNumber(otherFees.value || 0)}</td></tr>
                                <tr class="total-row"><td colspan="2">TOTAL TTC</td><td>${formatNumber(data.total)}</td></tr>
                            </tbody>
                        </table>
                        <div style="margin-top: 20px; font-style: italic; text-align: center;">
                            Arrêté la présente facture à la somme de : <strong>${numberToFrenchWords(Math.floor(data.total))}</strong> Francs CFA
                            <span style="font-weight: bold; color: #e74c3c;">(${formatNumber(data.total)} FCFA)</span>
                            <p style="font-weight: bold; background-color: red; color: white; border-radius: 5px; padding: 5px;">A payer avant le ${formatDate(dueDate)}</p>
                            <p> <small style="color: #7b8793; font-size: 12px;">En cas de retard de paiement, des pénalités de 5% seront appliquées après la date limite.</small></p>
                        </div>
                    </div>
                    <div class="payment-section">
                        <div class="payment-info">
                            <div class="invoice-section-title"><i class="fas fa-credit-card"></i> INFORMATIONS DE PAIEMENT</div>
                            <div class="deadline-card">
                                <div class="deadline-title"><i class="fas fa-clock"></i> DATE LIMITE DE PAIEMENT</div>
                                <div class="deadline-date">${formatDate(dueDate)}</div>
                            </div>
                            <div class="invoice-section-title" style="margin-top: 25px;"><i class="fas fa-wallet"></i> MODES DE PAIEMENT ACCEPTÉS</div>
                            <div class="payment-methods">
                                <div class="method-card"><i class="fas fa-mobile-alt"></i>Mobile Money</div>
                                <div class="method-card"><i class="fas fa-credit-card"></i>Carte Bancaire</div>
                                <div class="method-card"><i class="fas fa-money-bill-wave"></i>Espèces</div>
                            </div>
                        </div>
                        <div class="status-info">
                            <div class="invoice-section-title"><i class="fas fa-clipboard-check"></i> STATUT DE PAIEMENT</div>
                            <div class="status-card">
                                <p>Sélectionnez le statut actuel du paiement :</p>
                                <div class="status-options">
                                    <div class="status-option${status === 'pending' ? ' active' : ''}" data-status="pending"><i class="fas fa-clock"></i>En attente</div>
                                    <div class="status-option${status === 'paid' ? ' active' : ''}" data-status="paid"><i class="fas fa-check-circle"></i>Payé</div>
                                    <div class="status-option${status === 'overdue' ? ' active' : ''}" data-status="overdue"><i class="fas fa-exclamation-triangle"></i>En retard</div>
                                </div>
                                <div class="penalty-info"><i class="fas fa-info-circle"></i> En cas de retard de paiement, des pénalités de 5% seront appliquées après la date limite.</div>
                            </div>
                        </div>
                    </div>
                    <div class="signature-section">
                        <div class="signature-box"><div>Pour le fournisseur</div><div class="signature-placeholder"></div><div>ÉNERGIE DU SAHEL</div></div>
                        <div class="signature-box"><div>Signature du client</div><div class="signature-placeholder"></div><div>${clientName.value}</div></div>
                    </div>
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="downloadPDF()"><i class="fas fa-download"></i> Télécharger PDF</button>
                        <button class="btn btn-secondary" onclick="window.print()"><i class="fas fa-print"></i> Imprimer</button>
                        <button id="shareBtn" class="btn btn-secondary"><i class="fas fa-share-alt"></i> Partager la facture</button>

                    </div>
                `;

                // Après invoicePreview.innerHTML = `...`;
                setTimeout(() => {
                    const shareBtn = document.getElementById('shareBtn');
                    if (shareBtn) {
                        shareBtn.onclick = async () => {
                            loader.style.display = 'flex';
                            setTimeout(async () => {
                                const canvas = await html2canvas(invoicePreview, { scale: 2 });
                                canvas.toBlob(async (blob) => {
                                    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'facture.png', { type: blob.type })] })) {
                                        try {
                                            await navigator.share({
                                                files: [new File([blob], 'facture.png', { type: blob.type })],
                                                title: 'Facture Électricité',
                                                text: 'Voici votre facture générée avec ElecFacture Pro.'
                                            });
                                            showToast('Facture partagée avec succès !');
                                        } catch (e) {
                                            showToast('Partage annulé ou non supporté.');
                                        }
                                    } else {
                                        // Fallback : téléchargement de l'image si le partage n'est pas supporté
                                        const url = URL.createObjectURL(blob);
                                        const a = document.createElement('a');
                                        a.href = url;
                                        a.download = 'facture.png';
                                        a.click();
                                        URL.revokeObjectURL(url);
                                        showToast('Partage non supporté, image téléchargée.');
                                    }
                                    loader.style.display = 'none';
                                }, 'image/png');
                            }, 400);
                        };
                    }
                }, 100);
                // Ajout listeners statut interactif
                document.querySelectorAll('.status-option').forEach(opt => {
                    opt.onclick = () => {
                        currentStatus = opt.dataset.status;
                        generateInvoice(currentStatus);
                    };
                });
                // Sauvegarde dans l'historique
                backend.saveInvoice({
                    clientName: clientName.value,
                    clientAddress: clientAddress.value,
                    clientId: clientId.value,
                    meterId: meterId.value,
                    clientPhone: clientPhone.value,
                    issueDate: issueDate.value,
                    period: period.value,
                    oldIndex: oldIndex.value,
                    newIndex: newIndex.value,
                    ratePerKwh: ratePerKwh.value,
                    fixedFees: fixedFees.value,
                    taxRate: taxRate.value,
                    otherFees: otherFees.value,
                    consumption: data.consumption,
                    total: data.total,
                    status: currentStatus,
                    dueDate: dueDate.toISOString()
                });
                loadInvoices();
                loader.style.display = 'none';
                showToast('Facture générée avec succès!');
            }, 600);
        }

        // --- Export PDF ---
       // ...existing code...

        function downloadPDF() {
            loader.style.display = 'flex';
            setTimeout(() => {
                // Augmente la résolution du canvas (scale: 2 ou 3)
                html2canvas(invoicePreview, { scale: 3 }).then(canvas => {
                    const imgData = canvas.toDataURL('image/png');
                    const pdf = new jsPDF('p', 'mm', 'a4');
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
                    pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                    pdf.save(`facture-electrique-${new Date().getTime()}.pdf`);
                    loader.style.display = 'none';
                    showToast('PDF téléchargé avec succès!');
                });
            }, 400);
        }
        // ...existing code...

        // --- Réinitialisation formulaire ---
        function resetForm() {
            [clientName, clientAddress, clientId, meterId, clientPhone, period, oldIndex, newIndex, ratePerKwh, fixedFees, taxRate, otherFees].forEach(f => f.value = '');
            issueDate.value = new Date().toISOString().split('T')[0];
            invoicePreview.innerHTML = '';
            currentStatus = 'pending';
            showToast('Formulaire réinitialisé!');
        }

        // --- Sauvegarde/chargement temporaire ---
        function saveData() {
            const data = {
                clientName: clientName.value, clientAddress: clientAddress.value, clientId: clientId.value, meterId: meterId.value,
                clientPhone: clientPhone.value, issueDate: issueDate.value, period: period.value, oldIndex: oldIndex.value,
                newIndex: newIndex.value, ratePerKwh: ratePerKwh.value, fixedFees: fixedFees.value, taxRate: taxRate.value, otherFees: otherFees.value
            };
            localStorage.setItem('invoiceData', JSON.stringify(data));
            showToast('Données enregistrées avec succès!');
        }
        function loadData() {
            const saved = localStorage.getItem('invoiceData');
            if (saved) {
                const d = JSON.parse(saved);
                clientName.value = d.clientName || '';
                clientAddress.value = d.clientAddress || '';
                clientId.value = d.clientId || '';
                meterId.value = d.meterId || '';
                clientPhone.value = d.clientPhone || '';
                issueDate.value = d.issueDate || new Date().toISOString().split('T')[0];
                period.value = d.period || '';
                oldIndex.value = d.oldIndex || '';
                newIndex.value = d.newIndex || '';
                ratePerKwh.value = d.ratePerKwh || '';
                fixedFees.value = d.fixedFees || '';
                taxRate.value = d.taxRate || '';
                otherFees.value = d.otherFees || '';
                showToast('Données chargées avec succès!');
            }
        }

        // --- Historique avec recherche ---
        function loadInvoices(filter = '') {
            const invoices = backend.getAllInvoices();
            invoicesList.innerHTML = '';
            let filtered = invoices;
            if (filter && filter.trim().length > 0) {
                filtered = invoices.filter(inv =>
                    (inv.clientName && inv.clientName.toLowerCase().includes(filter.toLowerCase())) ||
                    (inv.clientId && inv.clientId.toLowerCase().includes(filter.toLowerCase()))
                );
            }
            if (filtered.length === 0) {
                invoicesList.innerHTML = '<p class="no-invoices">Aucune facture enregistrée</p>';
                return;
            }
            filtered.forEach(invoice => {
                const dueDate = new Date(invoice.dueDate), today = new Date();
                let status = invoice.status || 'pending', statusText = 'En attente';
                if (status === 'paid') statusText = 'Payé';
                else if (status === 'overdue' || today > dueDate) statusText = 'En retard';
                const card = document.createElement('div');
                card.className = 'invoice-card';
                card.innerHTML = `
                    <div class="invoice-info-card">
                        <div class="invoice-title">Facture ${invoice.clientId}</div>
                        <div class="invoice-meta">
                            <span><i class="fas fa-user"></i> ${invoice.clientName}</span>
                            <span><i class="fas fa-calendar"></i> ${formatDate(invoice.createdAt)}</span>
                        </div>
                    </div>
                    <div class="invoice-amount">${formatNumber(invoice.total)} FCFA</div>
                    <div class="invoice-status ${status}" title="Cliquer pour changer le statut">${statusText}</div>
                    <div class="invoice-actions">
                        <button class="btn btn-secondary" onclick="viewInvoice('${invoice.id}')"><i class="fas fa-eye"></i></button>
                        <button class="btn btn-danger" onclick="deleteInvoice('${invoice.id}')"><i class="fas fa-trash"></i></button>
                    </div>
                `;
                // Statut interactif
                card.querySelector('.invoice-status').onclick = () => {
                    let next = status === 'pending' ? 'paid' : status === 'paid' ? 'overdue' : 'pending';
                    backend.updateInvoiceStatus(invoice.id, next);
                    loadInvoices(searchInvoice.value);
                    showToast('Statut mis à jour !');
                };
                invoicesList.appendChild(card);
            });
        }

// --- Visualisation d'une facture ---
function viewInvoice(invoiceId) {
    const inv = backend.getInvoiceById(invoiceId);
    if (inv) {
        clientName.value = inv.clientName;
        clientAddress.value = inv.clientAddress;
        clientId.value = inv.clientId;
        meterId.value = inv.meterId;
        clientPhone.value = inv.clientPhone;
        issueDate.value = inv.issueDate;
        period.value = inv.period;
        oldIndex.value = inv.oldIndex;
        newIndex.value = inv.newIndex;
        ratePerKwh.value = inv.ratePerKwh;
        fixedFees.value = inv.fixedFees;
        taxRate.value = inv.taxRate;
        otherFees.value = inv.otherFees;
        currentStatus = inv.status || 'pending';
        generateInvoice(currentStatus);
        window.scrollTo({top: 0, behavior: 'smooth' });
    }
}

// --- Suppression d'une facture ---
function deleteInvoice(invoiceId) {
    if (confirm('Êtes-vous sûr de vouloir supprimer cette facture ?')) {
        backend.deleteInvoice(invoiceId);
        loadInvoices(searchInvoice.value);
        showToast('Facture supprimée avec succès!');
    }
}

// --- Événements principaux ---
generateBtn.addEventListener('click', () => generateInvoice());
exportBtn.addEventListener('click', downloadPDF);
newBtn.addEventListener('click', resetForm);
saveBtn.addEventListener('click', saveData);
searchInvoice.addEventListener('input', e => loadInvoices(e.target.value));

// Génération automatique si tous les champs sont remplis
[oldIndex, newIndex, ratePerKwh].forEach(input => {
    input.addEventListener('input', () => {
        if (oldIndex.value && newIndex.value && ratePerKwh.value) {
            generateInvoice(currentStatus);
        }
    });
});

// Chargement initial
window.addEventListener('DOMContentLoaded', () => {
    loadData();
    loadInvoices();
});
</script>
<div class="loader" id="loader">
    <div class="spinner"></div>
</div>
<div class="toast" id="toast"><i class="fas fa-check-circle"></i><span id="toastMessage"></span></div>

<!-- Footer ajouté -->
<footer
    style="width:100%;text-align:center;padding:18px 0 10px 0;background:#f1f5fa;color:#1e90ff;font-weight:500;font-size:1rem;letter-spacing:1px;position:relative;bottom:0;">
    &copy; <span id="year"></span> Rogastech - Tous droits réservés
</footer>

<script>
    // ...tout le JS existant...

    // Affiche l'année courante dans le footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // ...fin du JS existant...
</script>
<script>
    // ...existing code...

        // --- Sauvegarde automatique à chaque modification du formulaire ---
        [
            clientName, clientAddress, clientId, meterId, clientPhone, issueDate, period,
            oldIndex, newIndex, ratePerKwh, fixedFees, taxRate, otherFees
        ].forEach(input => {
            input.addEventListener('input', () => {
                saveData(); // Sauvegarde automatique à chaque saisie
                logAction('auto-save', 'Données du formulaire sauvegardées automatiquement.');
            });
        });

        // --- Journalisation des actions ---
        function logAction(type, message) {
            const logs = JSON.parse(localStorage.getItem('factureLogs') || '[]');
            logs.push({
                type,
                message,
                date: new Date().toISOString()
            });
            localStorage.setItem('factureLogs', JSON.stringify(logs));
        }

        // Exemple d'utilisation dans les actions importantes :
        function saveData() {
            const data = {
                clientName: clientName.value, clientAddress: clientAddress.value, clientId: clientId.value, meterId: meterId.value,
                clientPhone: clientPhone.value, issueDate: issueDate.value, period: period.value, oldIndex: oldIndex.value,
                newIndex: newIndex.value, ratePerKwh: ratePerKwh.value, fixedFees: fixedFees.value, taxRate: taxRate.value, otherFees: otherFees.value
            };
            localStorage.setItem('invoiceData', JSON.stringify(data));
            showToast('Données enregistrées avec succès!');
            logAction('save', 'Données du formulaire sauvegardées manuellement.');
        }

        // Pour consulter les logs dans la console (optionnel)
        function printLogs() {
            const logs = JSON.parse(localStorage.getItem('factureLogs') || '[]');
            console.table(logs);
        }

        // ...existing code...
</script>
<script>
    // ...existing code...

        // Bouton et input pour importer un fichier JSON
        const importBtn = document.getElementById('importBtn');
        const importJson = document.getElementById('importJson');

        importBtn.addEventListener('click', () => importJson.click());

       // ...dans ton <script> principal...
        importJson.addEventListener('change', function () {
            const file = this.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (e) {
                try {
                    const data = JSON.parse(e.target.result);
                    if (Array.isArray(data)) {
                        // Ancien format : juste la liste des factures
                        localStorage.setItem('invoices', JSON.stringify(data));
                        showToast('Historique importé avec succès !');
                        loadInvoices();
                    } else if (data.invoices && Array.isArray(data.invoices)) {
                        // Nouveau format : { invoices: [...], factureLogs: [...] }
                        localStorage.setItem('invoices', JSON.stringify(data.invoices));
                        if (Array.isArray(data.factureLogs)) {
                            localStorage.setItem('factureLogs', JSON.stringify(data.factureLogs));
                        }
                        showToast('Historique et logs importés avec succès !');
                        loadInvoices();
                    } else if (data.factureLogs) {
                        // Si le fichier contient juste les logs
                        localStorage.setItem('factureLogs', JSON.stringify(data.factureLogs));
                        showToast('Logs importés avec succès !');
                    } else {
                        showToast('Aucune donnée exploitable trouvée dans ce fichier.');
                    }
                } catch (err) {
                    showToast('Fichier invalide !');
                }
            };
            reader.readAsText(file);
        });
        // ...existing code...


        const exportHistoryBtn = document.getElementById('exportHistoryBtn');
            exportHistoryBtn.addEventListener('click', () => {
                const invoices = localStorage.getItem('invoices') || '[]';
                const logs = localStorage.getItem('factureLogs') || '[]';
                const blob = new Blob([JSON.stringify({ invoices: JSON.parse(invoices), factureLogs: JSON.parse(logs) }, null, 2)], { type: "application/json" });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'historique_factures.json';
                a.click();
                URL.revokeObjectURL(url);
            });
</script>

<script>
    // ...existing code...

        const shareBtn = document.getElementById('shareBtn');

        shareBtn.addEventListener('click', async () => {
            loader.style.display = 'flex';
            setTimeout(async () => {
                // Génère une image de l'aperçu de la facture
                const canvas = await html2canvas(invoicePreview, { scale: 2 });
                canvas.toBlob(async (blob) => {
                    if (navigator.canShare && navigator.canShare({ files: [new File([blob], 'facture.png', { type: blob.type })] })) {
                        try {
                            await navigator.share({
                                files: [new File([blob], 'facture.png', { type: blob.type })],
                                title: 'Facture Électricité',
                                text: 'Voici votre facture générée avec ElecFacture Pro.'
                            });
                            showToast('Facture partagée avec succès !');
                        } catch (e) {
                            showToast('Partage annulé ou non supporté.');
                        }
                    } else {
                        // Fallback : téléchargement de l'image si le partage n'est pas supporté
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'facture.png';
                        a.click();
                        URL.revokeObjectURL(url);
                        showToast('Partage non supporté, image téléchargée.');
                    }
                    loader.style.display = 'none';
                }, 'image/png');
            }, 400);
        });
</script>





<!-- Ajoute ce bloc juste avant </body> -->
<div id="devPanel"
    style="position:fixed;bottom:0;right:0;z-index:99999;background:#fff;border-top-left-radius:12px;box-shadow:0 0 12px #bbb;width:340px;max-width:98vw;max-height:80vh;overflow:auto;display:none;">
    <div
        style="background:#1e90ff;color:#fff;padding:10px 16px;border-top-left-radius:12px;display:flex;justify-content:space-between;align-items:center;">
        <span><i class="fas fa-tools"></i> Espace Développeur</span>
        <button onclick="document.getElementById('devPanel').style.display='none'"
            style="background:none;border:none;color:#fff;font-size:1.2em;cursor:pointer;">&times;</button>
    </div>
    <div style="padding:12px;">
        <button onclick="showDevTab('logs')" class="btn btn-secondary" style="margin-bottom:8px;">Console Logs</button>
        <button onclick="showDevTab('explorer')" class="btn btn-secondary" style="margin-bottom:8px;">Explorateur
            Données</button>
        <button onclick="showDevTab('stats')" class="btn btn-secondary" style="margin-bottom:8px;">Statistiques</button>
        <button onclick="showDevTab('courbe')" class="btn btn-secondary" style="margin-bottom:8px;">Courbe
            Consommation</button>
        <div id="devTabContent" style="margin-top:10px;max-height:45vh;overflow:auto;"></div>
    </div>
</div>
<button id="devPanelBtn"
    style="position:fixed;bottom:18px;right:18px;z-index:99998;background:#1e90ff;color:#fff;border:none;border-radius:50%;width:48px;height:48px;font-size:1.7em;box-shadow:0 2px 8px #bbb;cursor:pointer;">
    <i class="fas fa-terminal"></i>
</button>

<script>
    // Affichage du panneau développeur
    document.getElementById('devPanelBtn').onclick = () => {
        document.getElementById('devPanel').style.display = 'block';
        showDevTab('logs');
    };

    // Affichage des différents onglets
    function showDevTab(tab) {
        const content = document.getElementById('devTabContent');
        if (tab === 'logs') {
            const logs = JSON.parse(localStorage.getItem('factureLogs') || '[]');
            if (logs.length === 0) { content.innerHTML = "<em>Aucun log enregistré.</em>"; return; }
            content.innerHTML = `<pre style="font-size:0.95em;white-space:pre-wrap;background:#f7fafd;padding:8px;border-radius:6px;max-height:35vh;overflow:auto;">${logs.map(l => `[${l.date}] [${l.type}] ${l.message}`).join('\n')}</pre>
        <button class="btn btn-danger" onclick="clearLogs()" style="margin-top:8px;">Effacer les logs</button>
        <button class="btn btn-secondary" onclick="exportLogs()" style="margin-top:8px;">Exporter logs</button>`;
        }
        if (tab === 'explorer') {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            if (invoices.length === 0) { content.innerHTML = "<em>Aucune facture enregistrée.</em>"; return; }
            content.innerHTML = `<pre style="font-size:0.95em;white-space:pre-wrap;background:#f7fafd;padding:8px;border-radius:6px;max-height:35vh;overflow:auto;">${JSON.stringify(invoices, null, 2)}</pre>`;
        }
        if (tab === 'stats') {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            const logs = JSON.parse(localStorage.getItem('factureLogs') || '[]');
            let total = 0, totalConso = 0;
            invoices.forEach(f => { total += Number(f.total) || 0; totalConso += Number(f.consumption) || 0; });
            content.innerHTML = `
            <ul style="padding-left:18px;">
                <li><b>Nombre de factures :</b> ${invoices.length}</li>
                <li><b>Nombre de logs :</b> ${logs.length}</li>
                <li><b>Consommation totale (kWh) :</b> ${totalConso}</li>
                <li><b>Total facturé (FCFA) :</b> ${total.toLocaleString('fr-FR')}</li>
                <li><b>Taille stockage local :</b> ${Math.round(JSON.stringify(localStorage).length / 1024)} Ko</li>
            </ul>
        `;
        }
        if (tab === 'courbe') {
            const invoices = JSON.parse(localStorage.getItem('invoices') || '[]');
            if (invoices.length === 0) { content.innerHTML = "<em>Aucune donnée pour la courbe.</em>"; return; }
            // Prépare les données pour la courbe
            const labels = invoices.map(f => f.period || f.issueDate || '').reverse();
            const data = invoices.map(f => Number(f.consumption) || 0).reverse();
            content.innerHTML = `<canvas id="consoChart" width="300" height="160"></canvas>
        <div style="font-size:0.95em;color:#888;margin-top:8px;">Courbe de la consommation (kWh) par période/facture.</div>`;
            setTimeout(() => {
                if (window.Chart) {
                    const ctx = document.getElementById('consoChart').getContext('2d');
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Consommation (kWh)',
                                data: data,
                                borderColor: '#1e90ff',
                                backgroundColor: 'rgba(30,144,255,0.1)',
                                fill: true,
                                tension: 0.2
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: { legend: { display: false } },
                            scales: { x: { display: true }, y: { beginAtZero: true } }
                        }
                    });
                }
            }, 100);
        }
    }

    // Effacer les logs
    function clearLogs() {
        if (confirm('Effacer tous les logs ?')) {
            localStorage.removeItem('factureLogs');
            showDevTab('logs');
        }
    }

    // Exporter les logs
    function exportLogs() {
        const logs = localStorage.getItem('factureLogs') || '[]';
        const blob = new Blob([logs], { type: "application/json" });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'logs_factures.json';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Charge Chart.js pour la courbe si pas déjà présent
    if (!window.Chart) {
        const s = document.createElement('script');
        s.src = "https://cdn.jsdelivr.net/npm/chart.js";
        document.head.appendChild(s);
    }
</script>





<script>
    // --- Authentification locale ---
    const loginScreen = document.getElementById('loginScreen');
    const loginForm = document.getElementById('loginForm');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginError = document.getElementById('loginError');

    // Utilisateurs de test (à personnaliser)
    const USERS = [
        { user: "admin", pass: "David##28041980" },
        { user: "Rogastech", pass: "1234" }
    ];

    // Vérifie si connecté
    function isLoggedIn() {
        return !!localStorage.getItem('currentUser');
    }

    // Affiche l'écran de login si non connecté
    function checkAuth() {
        if (!isLoggedIn()) {
            document.body.style.overflow = "hidden";
            loginScreen.style.display = "flex";
        } else {
            document.body.style.overflow = "";
            loginScreen.style.display = "none";
        }
    }

    // Gère la connexion
    loginForm.onsubmit = function (e) {
            e.preventDefault();
            const user = loginUser.value.trim();
            const pass = loginPass.value;
            const found = USERS.find(u => u.user === user);
            let userPwd = localStorage.getItem('userPwd_' + user) || (found ? found.pass : '');
            if (found && pass === userPwd) {
                localStorage.setItem('currentUser', user);
                loginError.style.display = "none";
                loginScreen.style.display = "none";
                document.body.style.overflow = "";
                location.reload();
            } else {
                loginError.textContent = "Identifiants invalides";
                loginError.style.display = "block";
            }
        };
    // Déconnexion
    function logout() {
        localStorage.removeItem('currentUser');
        location.reload();
    }



    window.addEventListener('DOMContentLoaded', function () {
            const appControls = document.querySelector('.app-controls');
            if (appControls) {
                // Ajoute bouton déconnexion
                const logoutBtn = document.createElement('button');
                logoutBtn.className = "btn btn-danger";
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt"></i> Déconnexion';
                logoutBtn.onclick = logout;
                appControls.appendChild(logoutBtn);

                // Ajoute bouton changer mot de passe
                const changePwdBtn = document.createElement('button');
                changePwdBtn.className = "btn btn-secondary";
                changePwdBtn.innerHTML = '<i class="fas fa-key"></i> Changer mot de passe';
                changePwdBtn.onclick = showChangePwdModal;
                appControls.appendChild(changePwdBtn);
            }
        });
    // Filtre les données par utilisateur
    function getUserKey(key) {
        const user = localStorage.getItem('currentUser') || 'default';
        return key + '_' + user;
    }

    // Modifie le backend pour stocker/charger par utilisateur
    const _setItem = localStorage.setItem.bind(localStorage);
    const _getItem = localStorage.getItem.bind(localStorage);
    localStorage.setItem = function (key, value) {
        if (key === 'invoices' || key === 'factureLogs') {
            key = getUserKey(key);
        }
        _setItem(key, value);
    };
    localStorage.getItem = function (key) {
        if (key === 'invoices' || key === 'factureLogs') {
            key = getUserKey(key);
        }
        return _getItem(key);
    };

    // Vérifie l'authentification au chargement
    window.addEventListener('DOMContentLoaded', checkAuth);
</script>


<script>
    // Gestion du changement de mot de passe
        function showChangePwdModal() {
            document.getElementById('changePwdModal').style.display = 'flex';
            document.getElementById('changePwdError').style.display = 'none';
            document.getElementById('oldPwd').value = '';
            document.getElementById('newPwd').value = '';
            document.getElementById('confirmPwd').value = '';
        }
        function closeChangePwdModal() {
            document.getElementById('changePwdModal').style.display = 'none';
        }

        // Sauvegarde le mot de passe personnalisé dans localStorage
        document.getElementById('changePwdForm').onsubmit = function (e) {
            e.preventDefault();
            const oldPwd = document.getElementById('oldPwd').value;
            const newPwd = document.getElementById('newPwd').value;
            const confirmPwd = document.getElementById('confirmPwd').value;
            const user = localStorage.getItem('currentUser');
            // Vérifie l'ancien mot de passe
            let userPwd = localStorage.getItem('userPwd_' + user);
            if (!userPwd) {
                // Si pas encore personnalisé, cherche dans USERS
                const found = USERS.find(u => u.user === user);
                userPwd = found ? found.pass : '';
            }
            if (oldPwd !== userPwd) {
                document.getElementById('changePwdError').textContent = "Ancien mot de passe incorrect.";
                document.getElementById('changePwdError').style.display = 'block';
                return;
            }
            if (newPwd.length < 3) {
                document.getElementById('changePwdError').textContent = "Le nouveau mot de passe est trop court.";
                document.getElementById('changePwdError').style.display = 'block';
                return;
            }
            if (newPwd !== confirmPwd) {
                document.getElementById('changePwdError').textContent = "Les mots de passe ne correspondent pas.";
                document.getElementById('changePwdError').style.display = 'block';
                return;
            }
            localStorage.setItem('userPwd_' + user, newPwd);
            closeChangePwdModal();
            showToast("Mot de passe modifié !");
        };
</script>
</body>
</html>